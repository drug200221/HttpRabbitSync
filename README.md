# HttpRabbitSync Documentation

## Описание

**HttpRabbitSync** - это приложение, предназначенное для получения событий "Обнаружено лицо (Модуль распознавания лиц)" от системы видеонаблюдения Macroscop. Оно добавляет событие в очередь и поочередно обрабатывает его, отправляя запрос на обновление статуса студента в общежитии (да/нет в зависимости от того, вышел он или зашел).


## Установка и настройка

Настройте файл ``./development/app.config.json``

### 1. Настройка подключения к серверу Macroscop

Откройте файл `app.config.json` и замените строку подключения к серверу Macroscop на следующую:

```
http://{address}:{port}/event?login={login}&password={password}&filter={filter}&responsetype=json
```

#### Получение параметра {filter}

Чтобы узнать параметр {filter}, выполните следующие шаги:

1. Перейдите по следующему URL:

   ```
   http://{address}:{port}/command?type=getallregisteredevents&login={login}&password={password}
   ```

2. Скопируйте `id` у необходимого события. В нашем случае это событие "Обнаружено лицо (Модуль распознавания лиц)".

### 2. Настройка камер для распознавания студентов по общежитиям

Для обеспечения того, чтобы каждая камера распознавала только студентов своего общежития, необходимо добавить идентификатор базы лиц (DbId).

#### Выполните следующий PUT-запрос, чтобы настроить камеру с указанием нужного DbId:

   ```http
   PUT http://{address}:{port}/configure/channels/{ChannelId}/facescomplete
   Content-Type: application/json
   
   {
       "ChannelSettings": {
           "DbId": "perevoz_obsh_1"
       }
   }
   ```

Если все сделано правильно должно отобразиться поле для ввода идентификатора БД:

![Screenshot_2.png](Documentation/Screenshot_2.png)

### 3. Настройка информации о филиалах и общежитиях

В файле `app.config.json` необходимо заполнить информацию о филиалах и общежитиях. Пример структуры:

```json
"Branches": [
    {
        "name": "Перевоз",
        "Dormitories": [
            {
                "name": "Общежитие 1",
                "Cameras": [
                    {
                        "type": "EntranceCamera",
                        "id": ""
                    },
                    {
                        "type": "ExitCamera",
                        "id": ""
                    }
                ]
            }
        ]
    }
]
```

Укажите `name` филиала и общежития, а также `id` камер. Для получения информации о камерах воспользуйтесь следующим URL:

```
http://{address}:{port}/configex?login={login}&password=
```

### 4. Удобство работы с камерами

Для удобства работы с камерами, вы можете добавить их в папку с содержательным названием в **Macroscop Configurator**.

![Screenshot_1.png](Documentation/Screenshot_1.png)![2024-11-12_09-38.png](Documentation/2024-11-12_09-38.png)

> **Обратите внимание:**
> 
>``ChildChannels`` выводится по алфавиту, поэтому сверьте ``ChannelId`` с названием камеры.

### 5. Проверьте .env

Если необходимо поправьте .env как вам нужно.

### 6. Запуск
После настройки приложения, запустите его с помощью Docker. Для этого выполните следующую команду:
```console
docker compose up -d
```

Если правили .env после первого запуска:

```console
docker compose up -d --build
```

---

Следуйте этим шагам, чтобы правильно настроить приложение HttpRabbitSync для взаимодействия с системой Macroscop.
